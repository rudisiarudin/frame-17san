<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingkai Foto Acara</title>
    <!-- Tailwind CSS CDN untuk styling yang cepat -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
        }
        /* Kontainer kanvas yang akan diatur padding-top-nya secara dinamis */
        .canvas-container {
            position: relative;
            width: 100%;
            background-color: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden; /* Tambahkan ini untuk memastikan gambar yang diperbesar tidak keluar dari batas */
        }
        canvas, video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 1.5rem;
            object-fit: cover; /* Untuk memastikan video mengisi kontainer */
        }
        .draggable {
            cursor: grab;
        }
        .dragging {
            cursor: grabbing;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6">

    <div class="container mx-auto p-6 bg-white rounded-3xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-2">Buat Foto Acara Anda</h1>
        <p class="text-sm sm:text-base text-center text-gray-500 mb-8">Unggah foto, gunakan kamera, dan pilih ukuran.</p>

        <!-- Pilihan Ukuran -->
        <div class="mb-8">
            <p class="text-lg sm:text-xl font-semibold text-gray-700 text-center mb-4">Pilih Ukuran</p>
            <div class="flex justify-center gap-4">
                <button id="size-portrait" class="px-6 py-2 rounded-full font-semibold text-white bg-blue-500 hover:bg-blue-600 transition-colors" onclick="changeSize('portrait')">Potret</button>
                <button id="size-landscape" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors" onclick="changeSize('landscape')">Lanskap</button>
                <button id="size-square" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors" onclick="changeSize('square')">Persegi</button>
            </div>
        </div>

        <!-- Area Unggah Foto & Kamera -->
        <div class="mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
            <div class="w-full sm:w-auto">
                <label for="imageUpload" class="w-full sm:w-auto block text-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 cursor-pointer">
                    <i class="fas fa-upload mr-2"></i> Unggah Foto
                </label>
                <input type="file" id="imageUpload" accept="image/*" class="hidden"/>
            </div>
            
            <button id="cameraBtn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95">
                <i class="fas fa-camera mr-2"></i> Gunakan Kamera
            </button>
        </div>
        
        <!-- Video preview for camera -->
        <video id="cameraPreview" class="hidden" autoplay playsinline></video>

        <!-- Area Pratinjau Kanvas dan Bingkai -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-8 mb-8">
            <div class="w-full md:w-1/2">
                <div id="canvasContainer" class="canvas-container rounded-3xl">
                    <canvas id="photoCanvas" class="rounded-3xl"></canvas>
                    <div id="messageBox" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 bg-opacity-70 text-gray-600 rounded-3xl p-4 text-center text-sm transition-opacity duration-300 opacity-100">
                        <i class="fas fa-image text-4xl mb-2"></i>
                        <span class="ml-2">Unggah foto Anda atau gunakan kamera</span>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-1/2 flex flex-col items-center">
                <p class="text-lg sm:text-xl font-semibold text-gray-700 mb-4">Unggah Bingkai Anda</p>
                <!-- Area Unggah Bingkai -->
                <div class="w-full sm:w-auto">
                    <label for="frameUpload" class="w-full sm:w-auto block text-center bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 cursor-pointer">
                        <i class="fas fa-file-image mr-2"></i> Unggah Bingkai (PNG)
                    </label>
                    <input type="file" id="frameUpload" accept="image/png" class="hidden"/>
                </div>
            </div>
        </div>
        
        <!-- Kontrol Zoom -->
        <div id="zoomControls" class="flex flex-col items-center gap-2 mt-4 hidden">
            <p class="text-lg font-semibold text-gray-700">Perbesar/Perkecil</p>
            <input type="range" id="zoomSlider" min="1" max="3" value="1" step="0.05" class="w-full sm:w-1/2">
        </div>

        <!-- Tombol untuk mengambil foto dari kamera -->
        <div class="flex justify-center mb-4">
            <button id="takePhotoBtn" class="hidden bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed">
                <i class="fas fa-camera-retro mr-2"></i> Ambil Foto
            </button>
        </div>

        <!-- Tombol Unduh -->
        <div class="flex justify-center">
            <button id="downloadBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-download mr-2"></i> Unduh Foto
            </button>
        </div>

    </div>

    <script>
        // Mendapatkan elemen DOM yang dibutuhkan
        const imageUpload = document.getElementById('imageUpload');
        const frameUpload = document.getElementById('frameUpload');
        const cameraBtn = document.getElementById('cameraBtn');
        const cameraPreview = document.getElementById('cameraPreview');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const photoCanvas = document.getElementById('photoCanvas');
        const downloadBtn = document.getElementById('downloadBtn');
        const messageBox = document.getElementById('messageBox');
        const canvasContainer = document.getElementById('canvasContainer');
        const sizeButtons = document.querySelectorAll('.px-6.py-2.rounded-full');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomControls = document.getElementById('zoomControls');
        const ctx = photoCanvas.getContext('2d');

        // Variabel global untuk menyimpan gambar, stream kamera, dan bingkai kustom
        let currentImage = null;
        let cameraStream = null;
        let customFrameImage = null;

        // Mendefinisikan resolusi kanvas untuk setiap opsi ukuran
        const SIZES = {
            portrait: { width: 1536, height: 2816 },
            landscape: { width: 2816, height: 1536 },
            square: { width: 2000, height: 2000 }
        };

        let currentSize = SIZES.portrait;

        // Variabel untuk fungsionalitas seret, lepas, dan zoom
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let offsetX = 0;
        let offsetY = 0;
        let scale = 1;
        let lastPinchDistance = null; // Tambahkan variabel ini untuk menyimpan jarak cubit terakhir

        // Fungsi untuk menghitung jarak antara dua sentuhan
        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Fungsi untuk mengubah ukuran kanvas dan tampilan pratinjau
        function changeSize(mode) {
            currentSize = SIZES[mode];

            // Mengubah kelas tombol untuk menunjukkan yang aktif
            sizeButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(`size-${mode}`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`size-${mode}`).classList.add('bg-blue-500', 'text-white');

            // Mengatur rasio aspek CSS untuk kontainer pratinjau
            const aspectRatio = currentSize.height / currentSize.width;
            canvasContainer.style.paddingTop = `${aspectRatio * 100}%`;

            // Reset posisi dan zoom
            offsetX = 0;
            offsetY = 0;
            scale = 1;
            zoomSlider.value = 1;

            redrawCanvas();
        }

        // Fungsi untuk menggambar ulang kanvas
        function redrawCanvas() {
            photoCanvas.width = currentSize.width;
            photoCanvas.height = currentSize.height;
            ctx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);

            const source = currentImage ? currentImage : cameraPreview;

            if (source) {
                // Determine initial fit-to-canvas dimensions
                const imgAspectRatio = source.width / source.height;
                const canvasAspectRatio = photoCanvas.width / photoCanvas.height;
                let initialDrawW, initialDrawH;

                if (imgAspectRatio > canvasAspectRatio) {
                    initialDrawH = photoCanvas.height;
                    initialDrawW = initialDrawH * imgAspectRatio;
                } else {
                    initialDrawW = photoCanvas.width;
                    initialDrawH = initialDrawW / imgAspectRatio;
                }

                // Apply zoom
                const drawW = initialDrawW * scale;
                const drawH = initialDrawH * scale;

                // Adjust offsets for zooming
                const minOffsetX = photoCanvas.width - drawW;
                const minOffsetY = photoCanvas.height - drawH;
                offsetX = Math.max(Math.min(offsetX, 0), minOffsetX > 0 ? 0 : minOffsetX);
                offsetY = Math.max(Math.min(offsetY, 0), minOffsetY > 0 ? 0 : minOffsetY);

                // Calculate final draw position
                const drawX = (photoCanvas.width - drawW) / 2 + offsetX;
                const drawY = (photoCanvas.height - drawH) / 2 + offsetY;

                ctx.drawImage(source, drawX, drawY, drawW, drawH);
            }
            
            // Menggambar bingkai kustom jika ada
            if (customFrameImage) {
                ctx.drawImage(customFrameImage, 0, 0, photoCanvas.width, photoCanvas.height);
            }

            if (currentImage && customFrameImage) {
                downloadBtn.disabled = false;
            } else {
                downloadBtn.disabled = true;
            }
        }

        // Event listener untuk input file foto
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                cameraPreview.classList.add('hidden');
                takePhotoBtn.classList.add('hidden');
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        currentImage = img;
                        redrawCanvas();
                        messageBox.style.opacity = '0';
                        zoomControls.classList.remove('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Event listener untuk input file bingkai kustom
        frameUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        customFrameImage = img;
                        redrawCanvas();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Event listener untuk tombol kamera
        cameraBtn.addEventListener('click', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                cameraPreview.classList.add('hidden');
                takePhotoBtn.classList.add('hidden');
                messageBox.style.opacity = '1';
                zoomControls.classList.add('hidden');
                return;
            }

            navigator.mediaDevices.getUserMedia({ video: { width: { ideal: currentSize.width }, height: { ideal: currentSize.height } } })
                .then(stream => {
                    cameraStream = stream;
                    cameraPreview.srcObject = stream;
                    cameraPreview.classList.remove('hidden');
                    takePhotoBtn.classList.remove('hidden');
                    messageBox.style.opacity = '0';
                    currentImage = null;
                    downloadBtn.disabled = true; // Nonaktifkan unduh saat menggunakan kamera
                    zoomControls.classList.add('hidden'); // Sembunyikan kontrol zoom
                })
                .catch(err => {
                    messageBox.innerHTML = '<i class="fas fa-exclamation-circle text-4xl mb-2"></i><br/><span>Gagal mengakses kamera. Pastikan Anda memberikan izin.</span>';
                    messageBox.style.opacity = '1';
                    console.error("Kesalahan saat mengakses kamera: ", err);
                });
        });

        // Event listener untuk tombol ambil foto
        takePhotoBtn.addEventListener('click', () => {
            if (cameraStream) {
                currentImage = new Image();
                currentImage.onload = () => {
                    redrawCanvas();
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                    cameraPreview.classList.add('hidden');
                    takePhotoBtn.classList.add('hidden');
                    zoomControls.classList.remove('hidden');
                }
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = cameraPreview.videoWidth;
                tempCanvas.height = cameraPreview.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(cameraPreview, 0, 0, tempCanvas.width, tempCanvas.height);
                currentImage.src = tempCanvas.toDataURL('image/png');
            }
        });

        // Event listener untuk tombol unduh
        downloadBtn.addEventListener('click', () => {
            if (currentImage && customFrameImage) {
                const dataURL = photoCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `foto-bingkai-kustom.png`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
        
        // Fungsionalitas seret dan lepas (drag and drop)
        photoCanvas.addEventListener('mousedown', (e) => {
            if (currentImage) {
                isDragging = true;
                photoCanvas.classList.add('dragging');
                const rect = photoCanvas.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
            }
        });

        photoCanvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const rect = photoCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            offsetX += (mouseX - startX);
            offsetY += (mouseY - startY);
            startX = mouseX;
            startY = mouseY;

            redrawCanvas();
        });

        photoCanvas.addEventListener('mouseup', () => {
            isDragging = false;
            photoCanvas.classList.remove('dragging');
        });

        photoCanvas.addEventListener('mouseleave', () => {
            isDragging = false;
            photoCanvas.classList.remove('dragging');
        });

        // Event sentuhan untuk perangkat seluler
        photoCanvas.addEventListener('touchstart', (e) => {
            if (!currentImage) return;

            if (e.touches.length === 2) {
                // Jika dua sentuhan, hitung jarak awal untuk zoom
                lastPinchDistance = getDistance(e.touches);
                isDragging = false;
            } else if (e.touches.length === 1) {
                // Jika satu sentuhan, aktifkan penggeseran
                isDragging = true;
                photoCanvas.classList.add('dragging');
                const rect = photoCanvas.getBoundingClientRect();
                const touch = e.touches[0];
                startX = touch.clientX - rect.left;
                startY = touch.clientY - rect.top;
                lastPinchDistance = null; // Reset jarak cubit
            }
        });

        photoCanvas.addEventListener('touchmove', (e) => {
            if (!currentImage) return;
            e.preventDefault(); // Mencegah scrolling default

            if (e.touches.length === 2 && lastPinchDistance !== null) {
                // Tangani gerakan cubit untuk zoom
                const currentPinchDistance = getDistance(e.touches);
                const scaleFactor = currentPinchDistance / lastPinchDistance;
                scale = Math.max(1, Math.min(3, scale * scaleFactor)); // Batasi skala antara 1 dan 3
                zoomSlider.value = scale;
                lastPinchDistance = currentPinchDistance; // Perbarui jarak cubit terakhir
                redrawCanvas();
            } else if (e.touches.length === 1 && isDragging) {
                // Tangani gerakan satu jari untuk menggeser
                const rect = photoCanvas.getBoundingClientRect();
                const touch = e.touches[0];
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;

                offsetX += (touchX - startX);
                offsetY += (touchY - startY);
                startX = touchX;
                startY = touchY;
                
                redrawCanvas();
            }
        });

        photoCanvas.addEventListener('touchend', () => {
            isDragging = false;
            photoCanvas.classList.remove('dragging');
            lastPinchDistance = null; // Pastikan jarak cubit diatur ulang
        });

        // Event listener untuk slider zoom
        zoomSlider.addEventListener('input', (e) => {
            scale = parseFloat(e.target.value);
            redrawCanvas();
        });

        window.onload = function() {
            changeSize('portrait');
        };

        window.addEventListener('resize', () => {
            const canvasContainer = document.querySelector('.canvas-container');
            photoCanvas.style.width = canvasContainer.offsetWidth + 'px';
            photoCanvas.style.height = canvasContainer.offsetHeight + 'px';
        });

    </script>
</body>
</html>
