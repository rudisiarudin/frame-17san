<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Frame HUT RI - Bersatu Kita Gesit</title>
<style>
  :root { color-scheme: light; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#fafafa; color:#111; }
  .container { max-width:1160px; margin:0 auto; padding:16px 24px; }
  .grid { display:grid; grid-template-columns:1fr; gap:24px; }
  @media (min-width:1080px) { .grid { grid-template-columns:2fr 1fr; } }
  .card { background:#fff; border:1px solid #e5e5e5; border-radius:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .pad { padding:16px; } .row { display:flex; gap:8px; align-items:center; } .spacer { flex:1; }
  .btn { appearance:none; border:1px solid #e5e5e5; background:#fff; padding:8px 12px; border-radius:12px; font-size:13px; cursor:pointer; }
  .btn.primary { background:#111; color:#fff; border-color:#111; }
  .select, .input { padding:8px 10px; border:1px solid #e5e5e5; border-radius:12px; background:#fff; font-size:13px; }
  .wrap { position:relative; width:100%; border-radius:16px; overflow:hidden; }
  #wrap { aspect-ratio:9/16; background:#fff; }
  #preview { position:absolute; inset:0; width:100%; height:100%; touch-action:none; cursor:grab; }
  .hud { position:absolute; left:12px; top:12px; display:flex; gap:8px; }
  .chip { background:rgba(255,255,255,.85); border:1px solid #e5e5e5; padding:4px 8px; border-radius:10px; font-size:11px; }
  .thumbs { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
  .thumb { position:relative; aspect-ratio: 9/16; border:1px solid #e5e5e5; border-radius:12px; overflow:hidden; }
  .thumb img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
  .thumb.active { outline:2px solid #111; }
</style>
</head>
<body>
<div class="container">
  <header class="row" style="justify-content:space-between; margin-bottom:12px;">
    <div>
      <h1 style="margin:0">Frame HUT RI - Bersatu Kita Gesit</h1>
      <p style="margin:0;color:#555;font-size:13px">Abadikan moment mu dengan Frame ini</p>
    </div>
    <div class="row">
      <label for="ratioSel" style="font-size:12px;color:#666">Rasio:</label>
      <select id="ratioSel" class="select">
        <option value="9:16" selected>9:16 (Portrait)</option>
        <option value="1:1">1:1 (Square)</option>
        <option value="4:5">4:5 (Portrait)</option>
        <option value="4:3">4:3 (Landscape)</option>
        <option value="16:9">16:9 (Landscape)</option>
      </select>
    </div>
  </header>

  <div class="grid">
    <section class="card pad">
      <div id="wrap" class="wrap">
        <canvas id="preview"></canvas>
        <div class="hud">
          <span class="chip" id="designChip">—</span>
          <span class="chip" id="zoomChip" style="display:none">Zoom 100%</span>
        </div>
      </div>
      <div class="row" style="margin-top:12px; flex-wrap:wrap;">
        <button class="btn" id="zoomIn">Zoom in</button>
        <button class="btn" id="zoomOut">Zoom out</button>
        <button class="btn" id="center">Center</button>
        <div class="spacer"></div>
        <label style="font-size:12px;color:#666" for="exportSize">Export:</label>
        <select id="exportSize" class="select">
          <option value="720">720 px</option>
          <option value="1080" selected>1080 px</option>
          <option value="1440">1440 px</option>
        </select>
        <button class="btn primary" id="download">Download PNG</button>
      </div>
    </section>

    <aside class="card pad">
      <h3 style="margin:0 0 10px;">Kontrol</h3>
      <div class="row" style="gap:12px; flex-wrap:wrap;">
        <label style="font-size:12px;color:#666">Foto:
          <input type="file" id="photo" class="input" accept="image/*">
        </label>
      </div>
      <h3 style="margin:16px 0 8px;">Pilih / Upload Frame</h3>
      <div id="thumbs" class="thumbs" style="margin-bottom:8px;"></div>
      <label style="font-size:12px;color:#666">Upload Frame PNG:
        <input type="file" id="frameInput" class="input" accept="image/*">
      </label>
    </aside>
  </div>
</div>

<script>
(function(){
  // === KONFIG: ganti sesuai file di assets/frames ===
  const PRESET_FRAMES = [
    { name: 'GESIT Frame A', url: 'assets/frames/gesit-frame-a.png' },
    { name: 'GESIT Frame B', url: 'assets/frames/gesit-frame-b.png' }
  ];

  const state = { designW: 1080, designH: 1920, photo:null, frames:[], idx:-1, offset: {x:0,y:0}, zoom:1, exportSize:1080 };

  // DOM
  const wrap = document.getElementById('wrap');
  const canvas = document.getElementById('preview');
  const ctx = canvas.getContext('2d');
  const ratioSel = document.getElementById('ratioSel');
  const photoInput = document.getElementById('photo');
  const frameInput = document.getElementById('frameInput');
  const zoomIn = document.getElementById('zoomIn');
  const zoomOut = document.getElementById('zoomOut');
  const center = document.getElementById('center');
  const exportSel = document.getElementById('exportSize');
  const downloadBtn = document.getElementById('download');
  const thumbs = document.getElementById('thumbs');
  const zoomChip = document.getElementById('zoomChip');
  const designChip = document.getElementById('designChip');

  // Utils
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const coverScale=(pw,ph,dw,dh)=>Math.max(dw/pw, dh/ph);
  const computeExportHeight=(dw,dh,w)=>Math.round((dh/dw)*w);

  function drawChecker(g,w,h,size=16){
    g.save();
    g.fillStyle='#f5f5f5'; g.fillRect(0,0,w,h);
    g.fillStyle='#e5e5e5';
    for(let y=0;y<h;y+=size){
      for(let x=0;x<w;x+=size){
        if(((x+y)/size)%2<1) g.fillRect(x,y,size,size);
      }
    }
    g.restore();
  }

  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawChecker(ctx, canvas.width, canvas.height, 16*(window.devicePixelRatio||1));

    const dpr=Math.min(window.devicePixelRatio||1,2);
    const cssW=canvas.clientWidth, cssH=canvas.clientHeight;
    const kx=cssW/state.designW, ky=cssH/state.designH;
    ctx.scale(dpr,dpr);
    ctx.scale(kx,ky);

    if(state.photo){
      const s=coverScale(state.photo.w,state.photo.h,state.designW,state.designH)*state.zoom;
      const dw=state.photo.w*s, dh=state.photo.h*s;
      const x=state.designW/2+state.offset.x-dw/2;
      const y=state.designH/2+state.offset.y-dh/2;
      ctx.imageSmoothingQuality='high';
      ctx.drawImage(state.photo.img,x,y,dw,dh);
    }
    if(state.idx>=0){
      const f=state.frames[state.idx];
      ctx.drawImage(f.img,0,0,state.designW,state.designH);
    }

    zoomChip.style.display = state.photo ? '' : 'none';
    if(state.photo) zoomChip.textContent = 'Zoom '+Math.round(state.zoom*100)+'%';
    designChip.textContent = Math.round(state.designW)+'×'+Math.round(state.designH);
  }

  function resize(){
    wrap.style.aspectRatio = state.designW+' / '+state.designH;
    const dpr=Math.min(window.devicePixelRatio||1,2);
    const w=wrap.clientWidth;
    const h=Math.max(320, Math.round(w*(state.designH/state.designW)));
    canvas.style.width=w+'px';
    canvas.style.height=h+'px';
    canvas.width=Math.round(w*dpr);
    canvas.height=Math.round(h*dpr);
    draw();
  }
  new ResizeObserver(resize).observe(wrap);

  // Image helpers
// Image helpers
function dataUrlToImage(dataUrl, name){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = () =>
      resolve({
        img,
        w: img.naturalWidth,
        h: img.naturalHeight,
        src: dataUrl,              // <-- perbaikan: pakai ":" bukan "="
        name: name || 'frame.png'
      });
    img.onerror = reject;
    img.src = dataUrl;
  });
}

function urlToImage(url, name){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = () =>
      resolve({
        img,
        w: img.naturalWidth,
        h: img.naturalHeight,
        src: url,
        name: name || 'frame.png'
      });
    img.onerror = reject;
    img.src = url;
  });
}

function fileToImage(file){
  const url = URL.createObjectURL(file);
  return new Promise((resolve,reject)=>{
    const im = new Image();
    im.onload = () =>
      resolve({
        img: im,
        w: im.naturalWidth,
        h: im.naturalHeight,
        src: url,
        name: file.name
      });
    im.onerror = reject;
    im.src = url;
  });
}

  // Frames
  async function loadFrames(){
    const a=[];
    for(const it of PRESET_FRAMES){
      if (it.dataUrl) a.push(await dataUrlToImage(it.dataUrl, it.name));
      else if (it.url) a.push(await urlToImage(it.url, it.name));
    }
    state.frames=a;
    state.idx=a.length?0:-1;
    if(state.idx>=0){ const f=a[0]; state.designW=f.w; state.designH=f.h; }
    buildThumbs();
    resize();
    console.log('[Frames] loaded:', a.length);
  }

  function buildThumbs(){
    thumbs.innerHTML='';
    state.frames.forEach((f,i)=>{
      const b=document.createElement('button');
      b.className='thumb'+(i===state.idx?' active':'');
      const im=document.createElement('img');
      im.src=f.src;
      b.appendChild(im);
      b.addEventListener('click',()=>{
        state.idx=i;
        const ff=state.frames[i];
        state.designW=ff.w; state.designH=ff.h;
        state.offset={x:0,y:0};
        state.zoom=1;
        resize();
        buildThumbs();
      });
      thumbs.appendChild(b);
    });
  }

  // === Upload foto & frame
  photoInput.addEventListener('change', async (e)=>{
    const f=e.target.files && e.target.files[0];
    if(!f) return;
    state.photo=await fileToImage(f);
    state.offset={x:0,y:0};
    state.zoom=1;
    draw();
  });
  frameInput?.addEventListener('change', async (e)=>{
    const f=e.target.files && e.target.files[0];
    if(!f) return;
    const p=await fileToImage(f);
    state.frames=[...state.frames, p];
    state.idx=state.frames.length-1;
    state.designW=p.w; state.designH=p.h;
    state.offset={x:0,y:0}; state.zoom=1;
    buildThumbs(); resize();
    console.log('[Frame uploaded]', p.name, `(${p.w}x${p.h})`);
  });

  // === Controls (desktop)
  zoomIn.addEventListener('click',()=>{ state.zoom=clamp(state.zoom*1.1,0.2,8); draw(); });
  zoomOut.addEventListener('click',()=>{ state.zoom=clamp(state.zoom/1.1,0.2,8); draw(); });
  center.addEventListener('click',()=>{ state.offset={x:0,y:0}; draw(); });
  exportSel.addEventListener('change',()=>{ state.exportSize=Number(exportSel.value)||1080; });

  // === Zoom dengan scroll (desktop)
  canvas.addEventListener('wheel',e=>{
    e.preventDefault();
    const factor=Math.exp((-e.deltaY)*0.0015);
    const rect=canvas.getBoundingClientRect();
    const cssX=e.clientX-rect.left, cssY=e.clientY-rect.top;
    const kx=canvas.clientWidth/state.designW, ky=canvas.clientHeight/state.designH;
    const dx=cssX/kx, dy=cssY/ky;
    state.offset.x=(state.offset.x-dx)*factor+dx;
    state.offset.y=(state.offset.y-dy)*factor+dy;
    state.zoom=clamp(state.zoom*factor,0.2,8);
    draw();
  }, {passive:false});

  // === Gesture TOUCH (pan satu jari, pinch-zoom dua jari)
  const pointers = new Map(); // id -> {x,y}
  let pinch = null;          // {startDist, centerDesign:{x,y}, startZoom, startOffset:{x,y}}

  function getK(){
    return {
      kx: canvas.clientWidth / state.designW,
      ky: canvas.clientHeight / state.designH
    };
  }
  function cssToDesign(xCss, yCss){
    const {kx,ky} = getK();
    return { x: xCss / kx, y: yCss / ky };
  }

  canvas.addEventListener('pointerdown', (e)=>{
    canvas.setPointerCapture?.(e.pointerId);
    pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

    if (pointers.size === 1) {
      // start pan
      const p = pointers.get(e.pointerId);
      p.lastX = p.x; p.lastY = p.y;
    } else if (pointers.size === 2) {
      // start pinch
      const [p1, p2] = [...pointers.values()];
      const startDist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
      const rect = canvas.getBoundingClientRect();
      const centerCss = { x: (p1.x + p2.x)/2 - rect.left, y: (p1.y + p2.y)/2 - rect.top };
      const centerDesign = cssToDesign(centerCss.x, centerCss.y);
      pinch = {
        startDist,
        centerDesign,
        startZoom: state.zoom,
        startOffset: { x: state.offset.x, y: state.offset.y }
      };
    }
  });

  canvas.addEventListener('pointermove', (e)=>{
    if (!pointers.has(e.pointerId)) return;
    const p = pointers.get(e.pointerId);
    p.x = e.clientX; p.y = e.clientY;

    if (pinch && pointers.size >= 2) {
      // update pinch
      const [a, b] = [...pointers.values()];
      const newDist = Math.hypot(b.x - a.x, b.y - a.y);
      if (pinch.startDist > 0) {
        const rawFactor = newDist / pinch.startDist;
        const newZoom = clamp(pinch.startZoom * rawFactor, 0.2, 8);
        const f = newZoom / pinch.startZoom; // effective factor after clamp

        // zoom seputar titik tengah (centerDesign)
        state.zoom = newZoom;
        state.offset.x = (pinch.startOffset.x - pinch.centerDesign.x) * f + pinch.centerDesign.x;
        state.offset.y = (pinch.startOffset.y - pinch.centerDesign.y) * f + pinch.centerDesign.y;
        draw();
      }
    } else if (pointers.size === 1) {
      // pan satu jari
      const kx = canvas.clientWidth / state.designW;
      const ky = canvas.clientHeight / state.designH;
      const dx = (p.x - (p.lastX ?? p.x)) / kx;
      const dy = (p.y - (p.lastY ?? p.y)) / ky;
      p.lastX = p.x; p.lastY = p.y;
      state.offset.x += dx;
      state.offset.y += dy;
      draw();
    }
  });

  function endPointer(e){
    try{ canvas.releasePointerCapture?.(e.pointerId); }catch{}
    pointers.delete(e.pointerId);
    if (pointers.size < 2) {
      pinch = null; // selesai pinch
    }
    // reset lastX/lastY di pointer tersisa supaya pan lanjut halus
    if (pointers.size === 1) {
      const only = [...pointers.values()][0];
      only.lastX = only.x; only.lastY = only.y;
    }
  }
  canvas.addEventListener('pointerup', endPointer);
  canvas.addEventListener('pointercancel', endPointer);
  canvas.addEventListener('pointerleave', endPointer);

  // Tombol Download
  downloadBtn.addEventListener('click',()=>{
    const w=state.exportSize, h=computeExportHeight(state.designW,state.designH,w);
    const out=document.createElement('canvas');
    out.width=w; out.height=h;
    const g=out.getContext('2d');
    const k=w/state.designW;
    g.save(); g.scale(k,k);

    if(state.photo){
      const s=coverScale(state.photo.w,state.photo.h,state.designW,state.designH)*state.zoom;
      const dw=state.photo.w*s, dh=state.photo.h*s;
      const x=state.designW/2+state.offset.x-dw/2;
      const y=state.designH/2+state.offset.y-dh/2;
      g.imageSmoothingQuality='high';
      g.drawImage(state.photo.img,x,y,dw,dh);
    }
    if(state.idx>=0){
      const f=state.frames[state.idx];
      g.drawImage(f.img,0,0,state.designW,state.designH);
    }

    g.restore();
    out.toBlob((blob)=>{
      if(!blob) return;
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`twibbon-${w}x${h}.png`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1200);
    }, 'image/png');
  });

  // Rasio
  ratioSel.addEventListener('change',()=>{
    const [rw,rh]=ratioSel.value.split(':').map(Number);
    state.designW=1080;
    state.designH=Math.round(1080*(rh/rw));
    state.offset={x:0,y:0};
    state.zoom=1;
    resize();
  });

  // Boot
  loadFrames();
  resize();
})();
</script>

</body>
</html>
