<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bingkai Foto Acara</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    html, body { height: 100%; }
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .container { max-width: 980px; }
    .canvas-container {
      position: relative;
      width: 100%;
      background-color: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow: hidden;
    }
    canvas, video {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      border-radius: 1.5rem; object-fit: cover;
      touch-action: none; /* penting: agar gesture custom bekerja */
    }
    .draggable { cursor: grab; }
    .dragging { cursor: grabbing; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-8">
  <div class="container mx-auto p-6 bg-white rounded-3xl shadow-2xl">
    <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-2">Buat Foto Acara Anda</h1>
    <p class="text-sm sm:text-base text-center text-gray-500 mb-6">Unggah foto / pakai kamera, atur dengan cubit untuk zoom & geser dengan satu jari. Pilih bingkai bawaan.</p>

    <!-- Ukuran -->
    <div class="mb-6">
      <p class="text-lg sm:text-xl font-semibold text-gray-700 text-center mb-3">Pilih Ukuran</p>
      <div class="flex flex-wrap justify-center gap-3">
        <button id="size-portrait" class="px-6 py-2 rounded-full font-semibold text-white bg-blue-500 hover:bg-blue-600" onclick="changeSize('portrait')">Potret</button>
        <button id="size-landscape" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300" onclick="changeSize('landscape')">Lanskap</button>
        <button id="size-square" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300" onclick="changeSize('square')">Persegi</button>
      </div>
    </div>

    <!-- Upload & Kamera -->
    <div class="mb-6 flex flex-col sm:flex-row items-center justify-center gap-4">
      <div>
        <label for="imageUpload" class="block text-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg cursor-pointer">
          <i class="fas fa-upload mr-2"></i> Unggah Foto
        </label>
        <input type="file" id="imageUpload" accept="image/*" class="hidden" />
      </div>
      <button id="cameraBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">
        <i class="fas fa-camera mr-2"></i> Gunakan Kamera
      </button>
    </div>

    <video id="cameraPreview" class="hidden" autoplay playsinline></video>

    <!-- Kanvas & Panel Bingkai -->
    <div class="flex flex-col lg:flex-row gap-8 mb-6">
      <div class="w-full lg:w-2/3">
        <div id="canvasContainer" class="canvas-container rounded-3xl">
          <div class="w-full" id="ratioKeeper"></div>
          <canvas id="photoCanvas" class="rounded-3xl draggable"></canvas>
          <div id="messageBox" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 bg-opacity-70 text-gray-600 rounded-3xl p-4 text-center text-sm transition-opacity duration-300 opacity-100">
            <i class="fas fa-image text-4xl mb-2"></i>
            <span>Unggah foto Anda atau gunakan kamera</span>
          </div>
        </div>
      </div>

      <div class="w-full lg:w-1/3">
        <p class="text-lg sm:text-xl font-semibold text-gray-700 mb-2">Bingkai Bawaan</p>
        <div id="frameGrid" class="grid grid-cols-2 gap-3 mb-4"></div>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <label class="col-span-2 text-sm text-gray-600">Judul (opsional)</label>
          <input id="titleText" type="text" class="col-span-2 border rounded-xl px-3 py-2" placeholder="Nama Acara" />
          <label class="col-span-2 text-sm text-gray-600">Tanggal (opsional)</label>
          <input id="dateText" type="text" class="col-span-2 border rounded-xl px-3 py-2" placeholder="16 Agustus 2025" />
        </div>
        <div class="flex flex-wrap gap-3">
          <button id="clearFrameBtn" class="px-4 py-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-800">Tanpa Bingkai</button>
          <button id="downloadBtn" class="px-5 py-2 rounded-full bg-blue-500 hover:bg-blue-600 text-white shadow disabled:bg-gray-400" disabled>
            <i class="fas fa-download mr-2"></i>Unduh PNG
          </button>
        </div>
      </div>
    </div>

    <!-- Kontrol Zoom -->
    <div id="zoomControls" class="flex flex-col items-center gap-2 mt-2 hidden">
      <p class="text-lg font-semibold text-gray-700">Perbesar / Perkecil</p>
      <input type="range" id="zoomSlider" min="1" max="3" value="1" step="0.01" class="w-full sm:w-1/2" />
      <p class="text-xs text-gray-500">Tips: Cubit dengan dua jari untuk zoom; seret dengan satu jari untuk geser; ketuk dua kali untuk reset zoom.</p>
    </div>
  </div>

  <script>
    // Elemen
    const imageUpload = document.getElementById('imageUpload');
    const cameraBtn = document.getElementById('cameraBtn');
    const cameraPreview = document.getElementById('cameraPreview');
    const photoCanvas = document.getElementById('photoCanvas');
    const downloadBtn = document.getElementById('downloadBtn');
    const messageBox = document.getElementById('messageBox');
    const canvasContainer = document.getElementById('canvasContainer');
    const ratioKeeper = document.getElementById('ratioKeeper');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomControls = document.getElementById('zoomControls');
    const titleText = document.getElementById('titleText');
    const dateText = document.getElementById('dateText');
    const clearFrameBtn = document.getElementById('clearFrameBtn');
    const sizeButtons = [
      document.getElementById('size-portrait'),
      document.getElementById('size-landscape'),
      document.getElementById('size-square')
    ];
    const ctx = photoCanvas.getContext('2d');

    // Data
    const SIZES = {
      portrait: { w: 1536, h: 2816 },
      landscape: { w: 2816, h: 1536 },
      square: { w: 2000, h: 2000 }
    };
    let currentSizeKey = 'portrait';
    let currentSize = SIZES[currentSizeKey];

    // Gambar & kamera
    let currentImage = null; // HTMLImageElement
    let cameraStream = null; // MediaStream

    // Transformasi
    let isDragging = false;
    let startX = 0, startY = 0;
    let offsetX = 0, offsetY = 0; // translasi
    let scale = 1;                // zoom
    let lastPinchDistance = null; // untuk gesture dua jari

    // Frame bawaan (digambar via canvas)
    let activeFrameKey = 'minimal';

    const FRAMES = [
      { key: 'minimal', name: 'Minimal Putih', draw: (w,h) => {
          // border tipis
          ctx.save();
          ctx.lineWidth = Math.max(12, Math.min(w,h) * 0.006);
          ctx.strokeStyle = 'rgba(255,255,255,0.95)';
          ctx.strokeRect(0,0,w,h);
          ctx.restore();
        }
      },
      { key: 'rounded', name: 'Rounded Shadow', draw: (w,h) => {
          ctx.save();
          const r = Math.min(w,h) * 0.04;
          ctx.shadowColor = 'rgba(0,0,0,0.25)';
          ctx.shadowBlur = r * 0.8;
          ctx.strokeStyle = 'white';
          ctx.lineWidth = r * 0.6;
          roundedRectPath(0 + r, 0 + r, w - 2*r, h - 2*r, r);
          ctx.stroke();
          ctx.restore();
        }
      },
      { key: 'gradient', name: 'Gradien', draw: (w,h) => {
          const t = ctx.createLinearGradient(0,0,w,h);
          t.addColorStop(0, '#6366f1');
          t.addColorStop(1, '#ec4899');
          ctx.save();
          ctx.lineWidth = Math.max(24, Math.min(w,h) * 0.02);
          ctx.strokeStyle = t;
          roundedRectPath(12,12,w-24,h-24, Math.min(w,h)*0.04);
          ctx.stroke();
          ctx.restore();
        }
      },
      { key: 'ribbon', name: 'Pita Sudut', draw: (w,h) => {
          ctx.save();
          // sudut kiri atas
          ctx.fillStyle = '#ef4444';
          ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(w*0.18,0); ctx.lineTo(0,w*0.18); ctx.closePath(); ctx.fill();
          // sudut kanan bawah
          ctx.fillStyle = '#10b981';
          ctx.beginPath(); ctx.moveTo(w,h); ctx.lineTo(w,h - w*0.18); ctx.lineTo(w - w*0.18,h); ctx.closePath(); ctx.fill();
          ctx.restore();
        }
      },
      { key: 'eventCard', name: 'Kartu Acara', draw: (w,h) => {
          const pad = Math.max(24, Math.min(w,h)*0.02);
          // bar bawah
          ctx.save();
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          const barH = Math.max(80, h*0.12);
          ctx.fillRect(0,h-barH,w,barH);
          // teks
          ctx.fillStyle = '#fff';
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
          ctx.font = `700 ${Math.max(22, barH*0.33)}px Inter, ui-sans-serif`;
          const title = titleText.value?.trim() || '';
          const date = dateText.value?.trim() || '';
          ctx.fillText(title, pad, h - barH/2 - (date? barH*0.18:0));
          if (date) {
            ctx.globalAlpha = 0.9;
            ctx.font = `500 ${Math.max(16, barH*0.22)}px Inter, ui-sans-serif`;
            ctx.fillText(date, pad, h - barH/2 + barH*0.18);
          }
          ctx.restore();
        }
      }
    ];

    function roundedRectPath(x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
    }

    // Inisialisasi rasio container via padding-top agar responsif
    function setAspectRatio(){
      const ar = currentSize.h / currentSize.w; // tinggi/lebar
      ratioKeeper.style.paddingTop = (ar*100) + '%';
      layoutCanvasPixels();
    }

    // Sinkronkan ukuran pixel kanvas dengan ukuran logis yang dipilih
    function layoutCanvasPixels(){
      photoCanvas.width = currentSize.w;
      photoCanvas.height = currentSize.h;
      redrawCanvas();
    }

    function setActiveSizeButton(key){
      sizeButtons.forEach((btn)=>{
        btn.classList.remove('bg-blue-500','text-white');
        btn.classList.add('bg-gray-200','text-gray-700');
      });
      document.getElementById(`size-${key}`).classList.remove('bg-gray-200','text-gray-700');
      document.getElementById(`size-${key}`).classList.add('bg-blue-500','text-white');
    }

    function changeSize(key){
      currentSizeKey = key;
      currentSize = SIZES[key];
      setActiveSizeButton(key);
      // Reset transform
      offsetX = 0; offsetY = 0; scale = 1; zoomSlider.value = 1;
      setAspectRatio();
    }

    // Menggambar ulang
    function redrawCanvas(){
      ctx.clearRect(0,0,photoCanvas.width, photoCanvas.height);
      const source = currentImage ? currentImage : (cameraPreviewReady ? cameraPreview : null);
      if (source){
        // dimensi fit contain lalu skala oleh 'scale'
        const imgAR = source.width / source.height;
        const canvasAR = photoCanvas.width / photoCanvas.height;
        let baseW, baseH;
        if (imgAR > canvasAR) { // img lebih lebar
          baseH = photoCanvas.height;
          baseW = baseH * imgAR;
        } else {
          baseW = photoCanvas.width;
          baseH = baseW / imgAR;
        }
        const drawW = baseW * scale;
        const drawH = baseH * scale;
        // batasi offset agar gambar tetap menutupi kanvas
        const minOffsetX = Math.min(0, photoCanvas.width - drawW);
        const minOffsetY = Math.min(0, photoCanvas.height - drawH);
        offsetX = clamp(offsetX, minOffsetX, 0);
        offsetY = clamp(offsetY, minOffsetY, 0);
        const drawX = (photoCanvas.width - drawW)/2 + offsetX;
        const drawY = (photoCanvas.height - drawH)/2 + offsetY;
        ctx.drawImage(source, drawX, drawY, drawW, drawH);
      }
      // Gambar frame aktif
      if (activeFrameKey){
        const f = FRAMES.find(x=>x.key===activeFrameKey);
        if (f) f.draw(photoCanvas.width, photoCanvas.height);
      }
      downloadBtn.disabled = !sourceLoaded();
    }

    function sourceLoaded(){
      return !!(currentImage || cameraCapturedOnce);
    }

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // ===================== Upload Gambar =====================
    imageUpload.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      stopCamera();
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          currentImage = img;
          messageBox.style.opacity = '0';
          zoomControls.classList.remove('hidden');
          scale = 1; offsetX = 0; offsetY = 0; zoomSlider.value = 1;
          redrawCanvas();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // ===================== Kamera =====================
    let cameraPreviewReady = false;
    let cameraCapturedOnce = false;

    cameraBtn.addEventListener('click', async ()=>{
      if (cameraStream){ stopCamera(); return; }
      try{
        const constraints = { video: { facingMode: 'user' } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraStream = stream;
        cameraPreview.srcObject = stream;
        cameraPreview.classList.remove('hidden');
        cameraPreview.onloadedmetadata = () => {
          cameraPreview.play();
          cameraPreviewReady = true;
          messageBox.style.opacity = '0';
          currentImage = null; cameraCapturedOnce = false; zoomControls.classList.add('hidden');
          redrawCanvas();
        };
      } catch(err){
        messageBox.innerHTML = '<i class="fas fa-exclamation-circle text-4xl mb-2"></i><br/><span>Gagal mengakses kamera. Pastikan izin diberikan.</span>';
        messageBox.style.opacity = '1';
        console.error(err);
      }
    });

    function stopCamera(){
      if (cameraStream){
        cameraStream.getTracks().forEach(t=>t.stop());
        cameraStream = null; cameraPreviewReady = false;
        cameraPreview.classList.add('hidden');
      }
    }

    // Ambil frame dari kamera ke gambar agar bisa di-zoom/geser
    canvasContainer.addEventListener('dblclick', captureFromCameraIfAny);
    canvasContainer.addEventListener('touchend', (e)=>{ if (e.touches.length===0) maybeDoubleTap(e); }, {passive:true});

    let lastTapTime = 0;
    function maybeDoubleTap(e){
      const now = Date.now();
      if (now - lastTapTime < 300){ // double tap
        if (cameraStream){ captureFromCameraIfAny(); return; }
        // reset zoom
        scale = 1; offsetX = 0; offsetY = 0; zoomSlider.value = 1; redrawCanvas();
      }
      lastTapTime = now;
    }

    function captureFromCameraIfAny(){
      if (!cameraStream || !cameraPreviewReady) return;
      const temp = document.createElement('canvas');
      temp.width = cameraPreview.videoWidth;
      temp.height = cameraPreview.videoHeight;
      const tctx = temp.getContext('2d');
      tctx.drawImage(cameraPreview, 0,0,temp.width,temp.height);
      const img = new Image();
      img.onload = ()=>{ currentImage = img; cameraCapturedOnce = true; stopCamera(); zoomControls.classList.remove('hidden'); redrawCanvas(); };
      img.src = temp.toDataURL('image/png');
    }

    // ===================== Gesture & Input =====================
    function getCanvasPoint(evt){
      const rect = photoCanvas.getBoundingClientRect();
      return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    }

    // Mouse drag
    photoCanvas.addEventListener('mousedown', (e)=>{
      if (!sourceLoaded()) return;
      isDragging = true; photoCanvas.classList.add('dragging');
      const {x,y} = getCanvasPoint(e); startX = x; startY = y;
    });
    window.addEventListener('mousemove', (e)=>{
      if (!isDragging) return;
      const {x,y} = getCanvasPoint(e);
      offsetX += (x - startX); offsetY += (y - startY);
      startX = x; startY = y; redrawCanvas();
    });
    window.addEventListener('mouseup', ()=>{ isDragging=false; photoCanvas.classList.remove('dragging'); });

    // Wheel zoom (trackpad/mouse)
    photoCanvas.addEventListener('wheel', (e)=>{
      if (!sourceLoaded()) return;
      e.preventDefault();
      const delta = -e.deltaY; // ke atas = zoom in
      const zoomFactor = Math.exp(delta * 0.001);
      zoomAtPoint(zoomFactor, e.clientX, e.clientY);
    }, {passive:false});

    function zoomAtPoint(factor, clientX, clientY){
      const rect = photoCanvas.getBoundingClientRect();
      const cx = clientX - rect.left - photoCanvas.width/2 - offsetX;
      const cy = clientY - rect.top - photoCanvas.height/2 - offsetY;
      const newScale = clamp(scale * factor, 1, 3);
      const change = newScale / scale;
      // geser agar titik fokus relatif tetap
      offsetX -= cx * (change - 1);
      offsetY -= cy * (change - 1);
      scale = newScale; zoomSlider.value = scale.toFixed(2);
      redrawCanvas();
    }

    // Touch: satu jari drag, dua jari pinch-zoom
    photoCanvas.addEventListener('touchstart', (e)=>{
      if (!sourceLoaded()) return;
      if (e.touches.length === 2){
        lastPinchDistance = dist(e.touches[0], e.touches[1]);
        isDragging = false;
      } else if (e.touches.length === 1){
        isDragging = true; photoCanvas.classList.add('dragging');
        const rect = photoCanvas.getBoundingClientRect();
        startX = e.touches[0].clientX - rect.left;
        startY = e.touches[0].clientY - rect.top;
        lastPinchDistance = null;
      }
    }, {passive:false});

    photoCanvas.addEventListener('touchmove', (e)=>{
      if (!sourceLoaded()) return;
      e.preventDefault();
      if (e.touches.length === 2 && lastPinchDistance !== null){
        const d = dist(e.touches[0], e.touches[1]);
        const factor = d / lastPinchDistance;
        // zoom ke tengah kedua jari
        const midX = (e.touches[0].clientX + e.touches[1].clientX)/2;
        const midY = (e.touches[0].clientY + e.touches[1].clientY)/2;
        zoomAtPoint(factor, midX, midY);
        lastPinchDistance = d;
      } else if (e.touches.length === 1 && isDragging){
        const rect = photoCanvas.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        const y = e.touches[0].clientY - rect.top;
        offsetX += (x - startX); offsetY += (y - startY);
        startX = x; startY = y; redrawCanvas();
      }
    }, {passive:false});

    photoCanvas.addEventListener('touchend', ()=>{
      isDragging = false; photoCanvas.classList.remove('dragging'); lastPinchDistance = null;
    }, {passive:true});

    function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }

    // Slider zoom manual
    zoomSlider.addEventListener('input', (e)=>{ scale = parseFloat(e.target.value); redrawCanvas(); });

    // ===================== Frame UI =====================
    const frameGrid = document.getElementById('frameGrid');
    function renderFrameButtons(){
      frameGrid.innerHTML = '';
      FRAMES.forEach(f=>{
        const btn = document.createElement('button');
        btn.className = 'border rounded-xl p-2 hover:shadow focus:ring outline-none flex flex-col items-center';
        btn.title = f.name;
        btn.innerHTML = `<span class="text-sm mb-1">${f.name}</span><span class="text-xs text-gray-500">Pilih</span>`;
        btn.onclick = ()=>{ activeFrameKey = f.key; redrawCanvas(); };
        frameGrid.appendChild(btn);
      });
    }
    renderFrameButtons();

    clearFrameBtn.addEventListener('click', ()=>{ activeFrameKey = null; redrawCanvas(); });
    titleText.addEventListener('input', redrawCanvas);
    dateText.addEventListener('input', redrawCanvas);

    // ===================== Unduh =====================
    downloadBtn.addEventListener('click', ()=>{
      if (!sourceLoaded()) return;
      const a = document.createElement('a');
      a.download = 'foto-bingkai.png';
      a.href = photoCanvas.toDataURL('image/png');
      a.click();
    });

    // ===================== Lifecycle =====================
    window.addEventListener('resize', ()=>{ /* layout via CSS, pixel size tetap */ });

    // Mulai
    function init(){ changeSize('portrait'); messageBox.style.opacity='1'; zoomControls.classList.add('hidden'); }
    init();
  </script>
</body>
</html>
